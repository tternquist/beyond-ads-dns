name: Promote to Stable Tag

# Promote an existing release to the `stable` Docker tag.
# Use this to selectively mark a validated release as production-ready without
# changing `latest` (which always tracks the most recent release).
#
# Example: After validating v1.2.1 in staging, run this workflow with version
# "v1.2.1" to promote it to `stable`. Users on ghcr.io/org/repo:stable get that
# version until you promote a different one.

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version to promote (e.g. v1.2.3)'
        required: true
        type: string

permissions:
  contents: read
  packages: write

jobs:
  promote-stable:
    runs-on: [self-hosted, amd64]
    steps:
      - name: Validate and normalize version
        id: version
        run: |
          VER="${{ inputs.version }}"
          [[ "$VER" == v* ]] || VER="v$VER"
          echo "version=$VER" >> "$GITHUB_OUTPUT"
          echo "Promoting $VER to stable"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Promote to stable tag
        run: |
          IMAGE="ghcr.io/${{ github.repository }}"
          VER="${{ steps.version.outputs.version }}"

          # Verify the versioned image exists (fail fast if not)
          if ! docker buildx imagetools inspect $IMAGE:$VER >/dev/null 2>&1; then
            echo "::error::Image $IMAGE:$VER not found. Ensure the release exists and Docker images were built."
            exit 1
          fi

          # Create stable tag pointing to the selected release (no rebuild)
          docker buildx imagetools create -t $IMAGE:stable \
            $IMAGE:${VER}-amd64 \
            $IMAGE:${VER}-arm64

          echo "::notice::Promoted $VER to $IMAGE:stable"

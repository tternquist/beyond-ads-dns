server:
  listen:
    - "0.0.0.0:53"
  protocols:
    - udp
    - tcp
  read_timeout: "5s"
  write_timeout: "5s"

# Resolver strategy: failover (try in order, next on failure), load_balance (round-robin), weighted (prefer faster upstreams by response time)
resolver_strategy: failover
upstreams:
  - name: cloudflare
    address: "1.1.1.1:53"
  - name: google
    address: "8.8.8.8:53"
  - name: quad9
    address: "9.9.9.9:53"

blocklists:
  refresh_interval: "6h"
  sources:
    - name: hagezi-pro
      url: "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/domains/pro.txt"
  allowlist: []
  denylist: []

cache:
  redis:
    address: "redis:6379"
    db: 0
    password: ""
    lru_size: 10000  # L0 cache: local in-memory LRU cache size (0 to disable)
  min_ttl: "300s"
  max_ttl: "1h"
  negative_ttl: "5m"
  servfail_backoff: "60s"   # Back off before retrying after SERVFAIL (security/misconfig indicator)
  # respect_source_ttl: false  # When true, don't extend TTL with min_ttl (strict source TTL for Unbound)
  refresh:
    enabled: true
    hit_window: "1m"
    hot_threshold: 20
    min_ttl: "30s"
    hot_ttl: "2m"
    serve_stale: true
    stale_ttl: "5m"
    lock_ttl: "10s"
    max_inflight: 50
    sweep_interval: "15s"
    sweep_window: "2m"
    max_batch_size: 2000
    sweep_min_hits: 1
    sweep_hit_window: "48h"  # 48 hours
    # batch_stats_window: "2h"  # window for dynamic batch size stats (default 2h)
    # hit_count_sample_rate: 1.0  # Fraction of hits to count in Redis (0.01-1.0). Use 0.1 to reduce Redis load at high QPS.

response:
  blocked: "nxdomain"
  blocked_ttl: "1h"

request_log:
  enabled: false
  directory: "logs"
  filename_prefix: "dns-requests"

query_store:
  enabled: true
  address: "http://clickhouse:8123"
  database: "beyond_ads"
  table: "dns_queries"
  username: "beyondads"
  password: "beyondads"
  flush_to_store_interval: "5s"   # How often the app sends buffered events to ClickHouse
  flush_to_disk_interval: "5s"   # How often ClickHouse flushes async inserts to disk
  batch_size: 2000
  retention_days: 7

# Client identification: map client IPs to friendly names for per-device analytics.
# Enables "Which device queries X?" in query analytics (families/enterprise).
# client_identification:
#   enabled: true
#   clients:
#     "192.168.1.10": "kids-phone"
#     "192.168.1.11": "laptop"

# Local DNS records - returned without upstream lookup, work when internet is down
local_records: []

control:
  enabled: true
  listen: "0.0.0.0:8081"
  token: ""
  # errors:                  # Enabled by default (7-day retention)
  #   enabled: true
  #   retention_days: 7
  #   directory: "logs"
  #   filename_prefix: "errors"

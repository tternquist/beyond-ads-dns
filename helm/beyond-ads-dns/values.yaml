# Default values for beyond-ads-dns.
# See chart README and docs/helm-chart-feasibility.md for design notes.

# -- Number of app replicas (ignored when dns.exposeMode is hostNetwork and dns.daemonSet is true)
replicaCount: 1

image:
  repository: ghcr.io/tternquist/beyond-ads-dns
  tag: stable
  pullPolicy: IfNotPresent

# -- DNS exposure. Default nodePort avoids "didn't have free ports" (hostNetwork needs port 53/80 free on the node).
# nodePort: DNS at <node-ip>:nodePort (no hostNetwork). hostNetwork: bind port 53 on node (often conflicts with systemd-resolved).
dns:
  exposeMode: nodePort
  nodePort: 30053   # must be 30000-32767
  daemonSet: false   # only used when exposeMode is hostNetwork (one resolver per node)

# -- Redis (required). Use external Redis (redis.url) or install Bitnami Redis as a dependency (redis.enabled: true).
redis:
  # When true, installs Bitnami Redis as a subchart and app uses it automatically. When false, set redis.url to your Redis.
  enabled: false
  url: "redis://beyond-ads-dns-redis:6379"
  # existingSecret: ""   # when using external Redis: secret with REDIS_PASSWORD or redis-url
  # passwordSecretKey: REDIS_PASSWORD
  # --- Bitnami Redis subchart values (used only when redis.enabled: true) ---
  architecture: standalone
  auth:
    enabled: false
  # Use latest so pulls succeed (Bitnami removes old versioned tags; set a specific tag to pin)
  image:
    tag: latest
  master:
    persistence:
      enabled: true
      size: 512Mi

# -- ClickHouse (optional query store). Use external URL or install via a dependency chart.
clickhouse:
  enabled: false
  url: "http://clickhouse:8123"
  database: beyond_ads
  table: dns_queries
  username: beyondads
  # existingSecret: ""   # keys: password or clickhouse-password
  # Run a one-off Job to apply db/clickhouse/init.sql (use when using external ClickHouse)
  runInitJob: false

# -- Persist config-overrides (and admin password file) so UI/CLI changes survive restarts
config:
  persistence:
    enabled: true
    size: 1Gi
    # storageClass: ""  # optional
  # existingClaim: ""   # use existing PVC instead of creating one

# -- Extra env vars for the app (e.g. HOSTNAME, UI_PASSWORD, SESSION_SECRET)
extraEnv: []
# - name: HOSTNAME
#   value: "dns.example.com"
# - name: UI_PASSWORD
#   valueFrom:
#     secretKeyRef:
#       name: beyond-ads-dns-admin
#       key: password

# -- Extra env from existing secrets (e.g. REDIS_PASSWORD, QUERY_STORE_PASSWORD)
extraEnvFrom: []
# - secretRef:
#     name: beyond-ads-dns-redis
# - secretRef:
#     name: beyond-ads-dns-clickhouse

# -- Resource limits/requests
resources:
  requests:
    memory: "128Mi"
    cpu: "50m"
  limits:
    memory: "512Mi"
    cpu: "500m"

# -- Pod security context (container still needs cap_net_bind_service for port 53)
podSecurityContext:
  runAsNonRoot: false
  runAsUser: 0

securityContext:
  capabilities:
    add:
      - NET_BIND_SERVICE
  readOnlyRootFilesystem: false

# -- Node selector / affinity / tolerations
nodeSelector: {}
tolerations: []
affinity: {}

# -- Liveness/readiness/startup probes (control port 8081). App must connect to Redis and
# start the control server before /health succeeds; use startupProbe to avoid restarts during slow startup.
# With ClickHouse enabled, the app retries the query store for up to 2 minutes before /health is available,
# so the chart uses a longer startup failureThreshold when clickhouse.enabled is true.
probes:
  startup:
    enabled: true
    initialDelaySeconds: 5
    periodSeconds: 5
    # failureThreshold: set automatically (18 without ClickHouse, 24 with); override to tune (e.g. 30 for 2.5 min)
  liveness:
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
  readiness:
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3

# -- Ingress for Metrics UI (optional)
ingress:
  enabled: true
  className: ""
  annotations: {}
  hosts:
    - host: beyond-ads-dns.local
      paths:
        - path: /
          pathType: Prefix
  tls: []

# -- Service type for the main service (ClusterIP, NodePort, LoadBalancer)
service:
  type: ClusterIP
  # When dns.exposeMode is nodePort, DNS port 53 is always exposed as NodePort (dns.nodePort)
  metricsPort: 80
  controlPort: 8081

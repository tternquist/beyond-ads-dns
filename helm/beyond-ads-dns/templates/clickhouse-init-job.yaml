{{- if and .Values.clickhouse.enabled .Values.clickhouse.runInitJob }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "beyond-ads-dns.fullname" . }}-clickhouse-init
  labels:
    {{- include "beyond-ads-dns.labels" . | nindent 4 }}
data:
  # CREATE TABLE only (CREATE DATABASE is run separately via curl)
  init.sql: |
    CREATE TABLE IF NOT EXISTS beyond_ads.dns_queries
    (
        ts DateTime,
        client_ip String,
        client_name String DEFAULT '',
        protocol LowCardinality(String),
        qname String,
        qtype LowCardinality(String),
        qclass LowCardinality(String),
        outcome LowCardinality(String),
        rcode LowCardinality(String),
        duration_ms Float64,
        cache_lookup_ms Float64 DEFAULT 0,
        network_write_ms Float64 DEFAULT 0,
        upstream_address LowCardinality(String) DEFAULT ''
    )
    ENGINE = MergeTree
    PARTITION BY toDate(ts)
    ORDER BY (ts, qname)
    TTL toDate(ts) + INTERVAL 7 DAY;
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "beyond-ads-dns.fullname" . }}-clickhouse-init
  labels:
    {{- include "beyond-ads-dns.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 10
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "beyond-ads-dns.name" . }}
        app.kubernetes.io/component: clickhouse-init
    spec:
      restartPolicy: OnFailure
      containers:
        - name: init
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e
              URL="{{ .Values.clickhouse.url }}"
              # ClickHouse HTTP: one query per POST body
              curl -sf -X POST "${URL}/" --data-binary "CREATE DATABASE IF NOT EXISTS beyond_ads"
              curl -sf -X POST "${URL}/" --data-binary @/init/init.sql
              echo "ClickHouse init done"
          volumeMounts:
            - name: init-sql
              mountPath: /init
              readOnly: true
          {{- if .Values.clickhouse.existingSecret }}
          env:
            - name: CH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.clickhouse.existingSecret }}
                  key: {{ .Values.clickhouse.passwordSecretKey | default "password" }}
          {{- end }}
      volumes:
        - name: init-sql
          configMap:
            name: {{ include "beyond-ads-dns.fullname" . }}-clickhouse-init
{{- end }}
